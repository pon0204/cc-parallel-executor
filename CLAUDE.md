# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際のClaude Code (claude.ai/code)へのガイダンスを提供します。

## プロジェクト概要

**Claude Code Terminal** (claude-code-terminal)は、複数のClaude Codeインスタンスの並列実行を可能にするウェブベースのターミナルアプリケーションです。インタラクティブなターミナルアクセスとREST API経由のプログラマティックな制御の両方を提供します。

## 一般的なコマンド

```bash
# 依存関係のインストール
npm install

# 開発モード（Next.jsフロントエンド）
npm run dev

# プロダクションビルド
npm run build

# プロダクションサーバー起動
npm run start

# ターミナルサーバー実行
npm run server
# または
node server-simple.js

# APIサーバー実行（並列実行用）
node server-api.js
```

## プロジェクト構造

```
claude-code-terminal/
├── app/                    # Next.js App Routerページ
│   ├── page.tsx           # ナビゲーション付きホームページ
│   ├── terminal/          # インタラクティブウェブターミナル
│   ├── control/           # APIコントロールインターフェース
│   ├── parallel/          # 並列実行管理
│   └── api/               # APIルートプロキシ
├── components/            # 共有UIコンポーネント（shadcn/ui）
├── server-simple.js       # WebSocketターミナルサーバー
├── server-api.js         # CC制御用REST APIサーバー
└── docs/                 # アーキテクチャドキュメント
```

## ハイレベルアーキテクチャ

### コアコンポーネント

1. **フロントエンド（Next.js 14）**
   - ルーティング用App Router
   - 型安全性のためのTypeScript
   - スタイリング用Tailwind CSS + shadcn/ui
   - ターミナルエミュレーション用xterm.js
   - リアルタイム通信用Socket.IOクライアント

2. **バックエンドサーバー**
   - **server-simple.js**: ターミナルI/Oを処理するWebSocketサーバー
   - **server-api.js**: プログラマティックなCC制御用REST APIサーバー
   - 適切なPTYエミュレーションのために`unbuffer`を使用

3. **CC並列実行システム**
   - 親CC（コントローラー）：タスク定義の読み込みと子CC管理
   - 子CC（ワーカー）：割り当てられたタスクを並列実行
   - 優先度ベースのキューイングを持つタスクスケジューラー
   - リアルタイム進捗監視

### 主要ページ

- **`/`** - プロジェクト概要のホームページ
- **`/terminal`** - 直接CC対話用インタラクティブターミナル
- **`/control`** - カスタムプロンプト付きAPIベースCCコントロール
- **`/parallel`** - 複数のCCインスタンスを同時管理

## 主要なアーキテクチャ決定事項

1. **マイクロサービスアーキテクチャ**：各コンポーネントが独立して動作
   - ターミナルサーバーとAPIサーバーは異なるポートで実行
   - フロントエンドはNext.js APIルート経由でAPIコールをプロキシ

2. **リアルタイム通信**：双方向ターミナルI/O用Socket.IO
   - ターミナルリサイズイベントの処理
   - リアルタイムで出力をストリーミング

3. **PTYエミュレーション**：適切なターミナル動作のために`unbuffer`（expectパッケージ）を使用
   - インタラクティブコマンドが正しく動作することを保証
   - ANSIカラーコードとフォーマットを維持

4. **タスク管理**：YAMLベースのタスク定義
   - 依存関係の解決
   - 優先度ベースのスケジューリング
   - 並列実行グループ

## ドキュメントからの重要なコンテキスト

### CC並列実行コンセプト
`docs/architecture.md`より：
- 親CCがタスク定義を読み込んで分析
- タスクスケジューラーが優先度付きキューを管理
- CCオーケストレーターが子インスタンスにタスクを割り当て
- ダッシュボードへのリアルタイム進捗レポート

### Ultrathinkプロトコル
- 親CCから子CCへの指示は必ず「ultrathink」キーワードで開始
- 子CCはultrathinkを検出してタスク実行モードに移行
- これにより親子CC間の確実な通信を保証

### タスク構造
`docs/task-structure.yaml`より：
- 依存関係と優先度で定義されたタスク
- 異なるタスクタイプのサポート：開発、設計、テスト、ドキュメント
- 並列実行用タスクグループ
- 成功条件付き実行フェーズ

### APIエンドポイント
CC制御用主要API：
```
POST /api/sessions       - 新しいCCセッション作成
GET /api/sessions/:id    - セッションステータス/出力取得
POST /api/batch          - タスクバッチ実行
```

## 開発ワークフロー

1. **開発開始**
   ```bash
   # ターミナル1: APIサーバー起動
   node server-api.js
   
   # ターミナル2: ターミナルサーバー起動  
   npm run server
   
   # ターミナル3: Next.js開発サーバー起動
   npm run dev
   ```

2. **前提条件**
   - Node.js 18+
   - expect/unbufferインストール済み（macOSでは`brew install expect`）
   - Claude APIキーが設定済み

3. **ポート使用**
   - 3000: Next.jsフロントエンド
   - 3001: ターミナルWebSocketとAPIサーバーの両方

## 一般的な問題と解決策

1. **unbufferが見つからない**：expectパッケージをインストール
2. **API接続失敗**：server-api.jsがポート3001で実行されていることを確認
3. **ターミナルが表示されない**：server-simple.jsが実行されていることを確認

## ベストプラクティス

1. **状態管理**：コンポーネント状態にReactフックを使用
2. **エラーハンドリング**：すべてのAPIコールは適切にエラーを処理すべき
3. **型安全性**：すべての新しいコードでTypeScriptを活用
4. **UIコンポーネント**：`/components/ui`から既存のshadcn/uiコンポーネントを使用
5. **スタイリング**：Tailwind CSSクラスを使用、インラインスタイルは避ける

## 将来の拡張（要件より）

- データベース統合（SQLite予定）
- タスク依存関係の視覚化強化
- パフォーマンスメトリクスダッシュボード
- Dockerコンテナ化
- タスク定義のエクスポート/インポート機能

## Claudeインスタンス向けメモ

- これはローカル開発ツールで、認証は実装されていません
- 開発を加速するための並列タスク実行用に設計されています
- ターミナルとAPI機能間のクリーンな分離を維持することに焦点を当てる
- コードベースはNext.js 14 App Routerパターンに従います